---
- name: Install coredns
  when: ansible_facts['os_family'] == "Archlinux"
  command: yay -S coredns-bin --noconfirm
  args:
    warn: no

- include: install-coredns-on-ubuntu.yml
  when: ansible_facts['os_family'] == "Debian"

- name: Create zones directory
  become: yes
  file:
    owner: coredns
    group: coredns
    path: /etc/coredns/zones
    state: directory

- name: set custom hosts file
  become: yes
  copy:
    mode: 0644
    owner: coredns
    group: coredns
    force: yes
    dest: /etc/coredns/hosts
    content: |
      127.0.0.1   localhost
      ::1         localhost
      127.0.0.1   nameserver
        
- name: add inventory hosts to hosts file
  when: '"wireguard" in inventory_hostname'
  become: yes
  ignore_errors: true
  blockinfile:
    dest: "/etc/coredns/hosts"
    insertafter: BOF
    state: present
    marker: "# {mark} {{ item }} ANSIBLE MANAGED HOST"
    block: |
      {{ hostvars[item].tags.wireguard_ip.split("/")[0] }} {{ hostvars[item].inventory_hostname }}
  loop: "{{ groups.all }}"

- name: set custom zone file for gugger.cloud
  become: yes
  copy:
    mode: 0644
    owner: coredns
    group: coredns
    force: yes
    dest: /etc/coredns/zones/gugger.cloud.zone
    content: |
      $ORIGIN gugger.cloud.
      $TTL 86400
      @	IN	SOA	ns1.gugger.cloud.	hostmaster.gugger.cloud. (
          2021052301 ; serial
          21600      ; refresh after 6 hours
          3600       ; retry after 1 hour
          604800     ; expire after 1 week
          86400 )    ; minimum TTL of 1 day
      ;
      ;
        IN	NS	ns1.gugger.cloud.
        IN	NS	ns2.gugger.cloud.
      ns1	IN	A	20.199.182.92
      ns2	IN	A	20.199.182.92

      manuel IN A 20.199.182.92
      www    IN A 20.199.182.92

- name: set custom zone file for .internal
  become: yes
  when: groups._k3s_agent is defined
  copy:
    mode: 0644
    owner: coredns
    group: coredns
    force: yes
    dest: /etc/coredns/zones/internal.zone
    content: |
      $ORIGIN internal.
      @	3600 IN	SOA sns.dns.icann.org. noc.dns.icann.org. 2017042745 7200 3600 1209600 3600
        3600 IN NS a.iana-servers.net.
        3600 IN NS b.iana-servers.net.

      {% for k3s_node in (groups._k3s_agent|union(groups._k3s_server)) %}
      *         IN  A     {{ hostvars[k3s_node]['tags']['wireguard_ip'].split("/")[0] }};
      {% endfor %}

- name: set custom zone file for .k8s
  become: yes
  copy:
    mode: 0644
    owner: coredns
    group: coredns
    force: yes
    dest: /etc/coredns/zones/k8s.zone
    content: |
      $ORIGIN k8s.
      @	3600 IN	SOA sns.dns.icann.org. noc.dns.icann.org. 2017042745 7200 3600 1209600 3600
        3600 IN NS a.iana-servers.net.
        3600 IN NS b.iana-servers.net.

      *         IN  A     10.0.235.70;

- name: Copy configuration file
  become: yes
  copy:
    mode: 0644
    owner: coredns
    group: coredns
    force: yes
    dest: /etc/coredns/Corefile
    content: |  
      . {
        health
        acl {
          allow net 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12 127.0.0.1
          block
        }
        prometheus 0.0.0.0:9153

        hosts /etc/coredns/hosts {
          fallthrough
        }

        forward . tls://9.9.9.9 {
          tls_servername dns.quad9.net
          health_check 30s
        }
        cache 3600
      }

      gugger.cloud. {
        file /etc/coredns/zones/gugger.cloud.zone
        prometheus 0.0.0.0:9153
        log
      }

      home. {
        acl {
          allow net 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12 127.0.0.1
          block
        }
        prometheus 0.0.0.0:9153

        forward . {{ hostvars[inventory_hostname].tags.wireguard_ip.split("/")[0] }}:8600
      }

      k8s. {
        acl {
          allow net 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12 127.0.0.1
          block
        }
        prometheus 0.0.0.0:9153

        file /etc/coredns/zones/k8s.zone
      }

      internal. {
        acl {
          allow net 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12 127.0.0.1
          block
        }
        prometheus 0.0.0.0:9153

        file /etc/coredns/zones/internal.zone
      }

      azure.com {
        acl {
          allow net 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12 127.0.0.1
          block
        }
        prometheus 0.0.0.0:9153

        forward . 168.63.129.16
      }

- name: ufw allow coredns udp
  become: yes
  ufw:
    rule: allow
    port: 53
    proto: udp

- name: ufw allow coredns tcp
  become: yes
  ufw:
    rule: allow
    port: 53
    proto: tcp

- name: ufw allow coredns metrics tcp ports
  become: yes
  ufw:
    rule: allow
    interface: wg0
    direction: in
    proto: tcp
    to_port: "9153"

- name: Make sure coredns is running
  become: yes
  ansible.builtin.systemd:
    state: restarted
    name: coredns
    enabled: yes

- name: Copy nameserver for systemd-resolved
  become: yes
  copy:
    force: yes
    mode: 0644
    dest: /etc/systemd/resolved.conf
    content: |
      [Resolve]
      DNSStubListener=no
      DNS=127.0.0.1
      Domains=service.home node.home
      FallbackDNS=9.9.9.9 1.1.1.1

- name: Make sure systemd-resolved is restarted
  become: yes
  ansible.builtin.systemd:
    state: restarted
    name: systemd-resolved
    enabled: yes

- name: create coredns service for consul
  become: yes
  copy:
    force: yes
    owner: consul
    group: consul
    dest: /etc/consul.d/coredns.json
    content: |
      {
        "service":
          {
            "id": "coredns",
            "name": "coredns",
            "port": 9153,
            "address":"",
            "checks": [
              {
                "id": "coredns-health",
                "name": "coredns health check",
                "http": "http://localhost:8080/health",
                "method": "GET",
                "interval": "30s"
              }
            ]
          }
      }

- name: reload consul
  command: consul reload